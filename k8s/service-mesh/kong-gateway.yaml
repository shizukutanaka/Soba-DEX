# ============================================================================
# Kong API Gateway Configuration
# Alternative to Istio - Lightweight API Gateway
# ============================================================================
#
# Prerequisites:
# 1. Install Kong: kubectl create -f https://bit.ly/k4k8s
# 2. Install Kong Ingress Controller
# 3. Create namespace: kubectl create namespace kong

---
# Kong Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kong-proxy
  namespace: security-monitor
  labels:
    app: kong-proxy
spec:
  replicas: 2
  selector:
    matchLabels:
      app: kong-proxy
  template:
    metadata:
      labels:
        app: kong-proxy
    spec:
      containers:
        - name: kong
          image: kong:3.4-alpine
          env:
            - name: KONG_DATABASE
              value: "off"
            - name: KONG_DECLARATIVE_CONFIG
              value: /kong/declarative/kong.yml
            - name: KONG_PROXY_ACCESS_LOG
              value: /dev/stdout
            - name: KONG_ADMIN_ACCESS_LOG
              value: /dev/stdout
            - name: KONG_PROXY_ERROR_LOG
              value: /dev/stderr
            - name: KONG_ADMIN_ERROR_LOG
              value: /dev/stderr
            - name: KONG_ADMIN_LISTEN
              value: "0.0.0.0:8001"
            - name: KONG_PROXY_LISTEN
              value: "0.0.0.0:8000, 0.0.0.0:8443 ssl"
          ports:
            - name: proxy
              containerPort: 8000
              protocol: TCP
            - name: proxy-ssl
              containerPort: 8443
              protocol: TCP
            - name: admin
              containerPort: 8001
              protocol: TCP
          volumeMounts:
            - name: kong-config
              mountPath: /kong/declarative
          resources:
            requests:
              cpu: 500m
              memory: 512Mi
            limits:
              cpu: 1000m
              memory: 1Gi
          livenessProbe:
            httpGet:
              path: /status
              port: 8001
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /status
              port: 8001
            initialDelaySeconds: 10
            periodSeconds: 5
      volumes:
        - name: kong-config
          configMap:
            name: kong-declarative-config

---
# Kong Service
apiVersion: v1
kind: Service
metadata:
  name: kong-proxy
  namespace: security-monitor
spec:
  type: LoadBalancer
  selector:
    app: kong-proxy
  ports:
    - name: proxy
      port: 80
      targetPort: 8000
      protocol: TCP
    - name: proxy-ssl
      port: 443
      targetPort: 8443
      protocol: TCP

---
# Kong Admin Service (Internal only)
apiVersion: v1
kind: Service
metadata:
  name: kong-admin
  namespace: security-monitor
spec:
  type: ClusterIP
  selector:
    app: kong-proxy
  ports:
    - name: admin
      port: 8001
      targetPort: 8001
      protocol: TCP

---
# Kong Declarative Configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: kong-declarative-config
  namespace: security-monitor
data:
  kong.yml: |
    _format_version: "3.0"
    _transform: true

    # Services
    services:
      # Main API Service
      - name: security-monitor-api
        url: http://security-monitor-service:3000
        protocol: http
        connect_timeout: 60000
        write_timeout: 60000
        read_timeout: 60000
        retries: 3

        # Routes for API
        routes:
          # Health Check
          - name: health-check
            paths:
              - /health
              - /health/live
              - /health/ready
            methods:
              - GET
            strip_path: false
            preserve_host: false

          # Events API
          - name: events-api
            paths:
              - /api/events
            methods:
              - GET
              - POST
            strip_path: false
            plugins:
              - name: rate-limiting
                config:
                  minute: 100
                  policy: local
              - name: request-size-limiting
                config:
                  allowed_payload_size: 1
              - name: response-ratelimiting
                config:
                  limits:
                    sms:
                      minute: 20

          # Incidents API
          - name: incidents-api
            paths:
              - /api/incidents
            methods:
              - GET
              - POST
              - PUT
              - PATCH
            strip_path: false
            plugins:
              - name: rate-limiting
                config:
                  minute: 100
              - name: jwt
                config:
                  key_claim_name: kid
                  secret_is_base64: false

          # Threat Intelligence API
          - name: threat-intel-api
            paths:
              - /api/threat-intelligence
            methods:
              - GET
            strip_path: false
            plugins:
              - name: rate-limiting
                config:
                  minute: 50
              - name: proxy-cache
                config:
                  strategy: memory
                  memory:
                    dictionary_name: kong_cache
                  content_type:
                    - "application/json"
                  cache_ttl: 300
                  cache_control: false

          # ML Prediction API
          - name: ml-prediction-api
            paths:
              - /api/ml
            methods:
              - POST
            strip_path: false
            plugins:
              - name: rate-limiting
                config:
                  minute: 20
              - name: request-timeout
                config:
                  http_timeout: 60000

          # Compliance API
          - name: compliance-api
            paths:
              - /api/compliance
            methods:
              - GET
              - POST
            strip_path: false
            plugins:
              - name: jwt
              - name: acl
                config:
                  allow:
                    - admin
                    - compliance-officer

          # Metrics (Prometheus)
          - name: metrics
            paths:
              - /metrics
            methods:
              - GET
            strip_path: false
            plugins:
              - name: ip-restriction
                config:
                  allow:
                    - 10.0.0.0/8
                    - 172.16.0.0/12
                    - 192.168.0.0/16

    # Global Plugins
    plugins:
      # CORS
      - name: cors
        config:
          origins:
            - "https://security-monitor.example.com"
          methods:
            - GET
            - POST
            - PUT
            - PATCH
            - DELETE
            - OPTIONS
          headers:
            - Accept
            - Authorization
            - Content-Type
            - X-Request-ID
          exposed_headers:
            - X-RateLimit-Limit
            - X-RateLimit-Remaining
          credentials: true
          max_age: 3600

      # Request ID
      - name: correlation-id
        config:
          header_name: X-Request-ID
          generator: uuid
          echo_downstream: true

      # Logging
      - name: file-log
        config:
          path: /dev/stdout
          reopen: true

      # Prometheus Metrics
      - name: prometheus
        config:
          per_consumer: true
          status_code_metrics: true
          latency_metrics: true
          bandwidth_metrics: true
          upstream_health_metrics: true

      # Request Transformer
      - name: request-transformer
        config:
          add:
            headers:
              - X-Gateway:Kong
              - X-Forwarded-By:security-monitor-gateway

      # Bot Detection
      - name: bot-detection
        config:
          allow:
            - curl
            - HTTPie
          deny:
            - BadBot
            - EvilScraper

      # IP Restriction (Global)
      - name: ip-restriction
        config:
          status: 403
          message: Access denied

---
# KongPlugin - Rate Limiting (Advanced)
apiVersion: configuration.konghq.com/v1
kind: KongPlugin
metadata:
  name: rate-limiting-advanced
  namespace: security-monitor
config:
  minute: 100
  hour: 10000
  policy: redis
  redis_host: redis-service
  redis_port: 6379
  redis_timeout: 2000
  fault_tolerant: true
plugin: rate-limiting

---
# KongPlugin - JWT Authentication
apiVersion: configuration.konghq.com/v1
kind: KongPlugin
metadata:
  name: jwt-auth
  namespace: security-monitor
config:
  key_claim_name: iss
  secret_is_base64: false
  claims_to_verify:
    - exp
    - nbf
plugin: jwt

---
# KongPlugin - Request Size Limiting
apiVersion: configuration.konghq.com/v1
kind: KongPlugin
metadata:
  name: request-size-limit
  namespace: security-monitor
config:
  allowed_payload_size: 5
  size_unit: megabytes
plugin: request-size-limiting

---
# KongPlugin - Response Transformer
apiVersion: configuration.konghq.com/v1
kind: KongPlugin
metadata:
  name: response-transformer
  namespace: security-monitor
config:
  add:
    headers:
      - X-Security-Monitor:enabled
      - X-Response-Time:$(latency)
  remove:
    headers:
      - X-Powered-By
      - Server
plugin: response-transformer

---
# KongPlugin - Circuit Breaker
apiVersion: configuration.konghq.com/v1
kind: KongPlugin
metadata:
  name: circuit-breaker
  namespace: security-monitor
config:
  max_failures: 5
  timeout: 60
  recovery_timeout: 120
plugin: proxy-circuit-breaker

---
# KongPlugin - Canary Deployment
apiVersion: configuration.konghq.com/v1
kind: KongPlugin
metadata:
  name: canary-deployment
  namespace: security-monitor
config:
  percentage: 10
  upstream_host: security-monitor-service-v2
  upstream_fallback: false
  upstream_port: 3000
plugin: canary

---
# KongIngress - Custom routing and load balancing
apiVersion: configuration.konghq.com/v1
kind: KongIngress
metadata:
  name: security-monitor-routing
  namespace: security-monitor
upstream:
  algorithm: consistent-hashing
  hash_on: header
  hash_on_header: X-User-ID
  slots: 1000
  healthchecks:
    active:
      healthy:
        interval: 10
        successes: 2
      unhealthy:
        interval: 5
        http_failures: 3
        timeouts: 3
      http_path: /health
      timeout: 5
      concurrency: 5
    passive:
      healthy:
        successes: 5
      unhealthy:
        http_failures: 5
        timeouts: 5
proxy:
  protocol: http
  connect_timeout: 60000
  write_timeout: 60000
  read_timeout: 60000
route:
  methods:
    - GET
    - POST
    - PUT
    - PATCH
    - DELETE
  strip_path: false
  preserve_host: true
  regex_priority: 0

---
# Ingress - Kubernetes Ingress with Kong annotations
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: security-monitor-ingress
  namespace: security-monitor
  annotations:
    kubernetes.io/ingress.class: kong
    konghq.com/strip-path: "false"
    konghq.com/preserve-host: "true"
    konghq.com/protocols: "https"
    konghq.com/https-redirect-status-code: "301"

    # Plugin annotations
    konghq.com/plugins: rate-limiting-advanced,jwt-auth,response-transformer

    # Override settings
    konghq.com/override: security-monitor-routing
spec:
  tls:
    - hosts:
        - security-monitor.example.com
        - api.security-monitor.example.com
      secretName: security-monitor-tls-cert
  rules:
    - host: security-monitor.example.com
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: security-monitor-service
                port:
                  number: 3000

    - host: api.security-monitor.example.com
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: security-monitor-service
                port:
                  number: 3000

---
# TCPIngress - For non-HTTP traffic (e.g., gRPC)
apiVersion: configuration.konghq.com/v1beta1
kind: TCPIngress
metadata:
  name: security-monitor-tcp
  namespace: security-monitor
  annotations:
    kubernetes.io/ingress.class: kong
spec:
  rules:
    - port: 9090
      backend:
        serviceName: security-monitor-service
        servicePort: 9090

---
# KongConsumer - API consumer/client
apiVersion: configuration.konghq.com/v1
kind: KongConsumer
metadata:
  name: admin-api-client
  namespace: security-monitor
  annotations:
    kubernetes.io/ingress.class: kong
username: admin-client
custom_id: admin-001

---
# JWT Credential for Consumer
apiVersion: configuration.konghq.com/v1
kind: KongCredential
metadata:
  name: admin-jwt-credential
  namespace: security-monitor
consumerRef: admin-api-client
type: jwt
config:
  key: admin-issuer
  algorithm: HS256
  secret: change-this-secret-in-production

---
# ACL Group for Consumer
apiVersion: configuration.konghq.com/v1
kind: KongCredential
metadata:
  name: admin-acl-group
  namespace: security-monitor
consumerRef: admin-api-client
type: acl
config:
  group: admin

---
# HorizontalPodAutoscaler for Kong
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: kong-proxy-hpa
  namespace: security-monitor
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: kong-proxy
  minReplicas: 2
  maxReplicas: 10
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80

---
# NetworkPolicy for Kong
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: kong-proxy-network-policy
  namespace: security-monitor
spec:
  podSelector:
    matchLabels:
      app: kong-proxy
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from anywhere on proxy ports
    - from:
        - podSelector: {}
      ports:
        - protocol: TCP
          port: 8000
        - protocol: TCP
          port: 8443

    # Allow from monitoring namespace on admin port
    - from:
        - namespaceSelector:
            matchLabels:
              name: monitoring
      ports:
        - protocol: TCP
          port: 8001

  egress:
    # Allow to security-monitor service
    - to:
        - podSelector:
            matchLabels:
              app: security-monitor
      ports:
        - protocol: TCP
          port: 3000

    # Allow to Redis
    - to:
        - podSelector:
            matchLabels:
              app: redis
      ports:
        - protocol: TCP
          port: 6379

    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              name: kube-system
        - podSelector:
            matchLabels:
              k8s-app: kube-dns
      ports:
        - protocol: UDP
          port: 53

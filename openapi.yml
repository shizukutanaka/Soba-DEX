openapi: 3.0.3
info:
  title: Security Monitoring API
  description: |
    Real-time security monitoring and threat detection system for DEX applications.

    ## Features
    - Real-time threat detection (13+ attack types)
    - Rate limiting and DDoS protection
    - Incident management
    - Prometheus metrics
    - Webhook notifications
    - Redis distributed caching
    - PostgreSQL event storage

    ## Security
    All endpoints support authentication via API key or JWT token.
    Rate limiting is enforced per IP and per API key.

  version: 3.0.0
  contact:
    name: Security Team
    email: security@yourdomain.com
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:3000
    description: Development server

tags:
  - name: Health
    description: Health check and system status endpoints
  - name: Events
    description: Security event management
  - name: Incidents
    description: Security incident management
  - name: Statistics
    description: Monitoring statistics and metrics
  - name: Alerts
    description: Alert management and configuration
  - name: Webhooks
    description: Webhook notification management
  - name: Cache
    description: Redis cache management
  - name: Circuit Breakers
    description: Circuit breaker status and control
  - name: Metrics
    description: Prometheus metrics

paths:
  /health:
    get:
      tags:
        - Health
      summary: Health check endpoint
      description: Returns the health status of all system components
      operationId: getHealth
      responses:
        '200':
          description: System is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
        '503':
          description: System is unhealthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

  /metrics:
    get:
      tags:
        - Metrics
      summary: Prometheus metrics endpoint
      description: Returns metrics in Prometheus text format
      operationId: getMetrics
      responses:
        '200':
          description: Metrics data
          content:
            text/plain:
              schema:
                type: string
                example: |
                  # HELP security_events_total Total number of security events
                  # TYPE security_events_total counter
                  security_events_total{type="SQL_INJECTION",severity="HIGH"} 42

  /api/events:
    get:
      tags:
        - Events
      summary: Get security events
      description: Retrieve security events with optional filtering
      operationId: getEvents
      parameters:
        - $ref: '#/components/parameters/LimitParam'
        - $ref: '#/components/parameters/OffsetParam'
        - name: type
          in: query
          description: Filter by event type
          schema:
            type: string
            enum: [SQL_INJECTION, XSS, COMMAND_INJECTION, PATH_TRAVERSAL, DDOS, RATE_LIMIT_EXCEEDED]
        - name: severity
          in: query
          description: Filter by severity
          schema:
            type: string
            enum: [LOW, MEDIUM, HIGH, CRITICAL]
        - name: ip
          in: query
          description: Filter by IP address
          schema:
            type: string
        - name: startTime
          in: query
          description: Start timestamp (milliseconds since epoch)
          schema:
            type: integer
            format: int64
        - name: endTime
          in: query
          description: End timestamp (milliseconds since epoch)
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: List of security events
          content:
            application/json:
              schema:
                type: object
                properties:
                  events:
                    type: array
                    items:
                      $ref: '#/components/schemas/SecurityEvent'
                  total:
                    type: integer
                  limit:
                    type: integer
                  offset:
                    type: integer

    post:
      tags:
        - Events
      summary: Create security event
      description: Manually create a security event
      operationId: createEvent
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateEventRequest'
      responses:
        '201':
          description: Event created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SecurityEvent'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/events/{eventId}:
    get:
      tags:
        - Events
      summary: Get event by ID
      description: Retrieve a specific security event
      operationId: getEventById
      parameters:
        - $ref: '#/components/parameters/EventIdParam'
      responses:
        '200':
          description: Event found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SecurityEvent'
        '404':
          description: Event not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/incidents:
    get:
      tags:
        - Incidents
      summary: Get security incidents
      description: Retrieve security incidents with optional filtering
      operationId: getIncidents
      parameters:
        - $ref: '#/components/parameters/LimitParam'
        - $ref: '#/components/parameters/OffsetParam'
        - name: severity
          in: query
          description: Filter by severity
          schema:
            type: string
            enum: [LOW, MEDIUM, HIGH, CRITICAL]
        - name: status
          in: query
          description: Filter by status
          schema:
            type: string
            enum: [ACTIVE, INVESTIGATING, RESOLVED, FALSE_POSITIVE]
      responses:
        '200':
          description: List of incidents
          content:
            application/json:
              schema:
                type: object
                properties:
                  incidents:
                    type: array
                    items:
                      $ref: '#/components/schemas/SecurityIncident'
                  total:
                    type: integer

  /api/incidents/{incidentId}:
    get:
      tags:
        - Incidents
      summary: Get incident by ID
      operationId: getIncidentById
      parameters:
        - $ref: '#/components/parameters/IncidentIdParam'
      responses:
        '200':
          description: Incident found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SecurityIncident'
        '404':
          description: Incident not found

    patch:
      tags:
        - Incidents
      summary: Update incident
      description: Update incident status or add notes
      operationId: updateIncident
      parameters:
        - $ref: '#/components/parameters/IncidentIdParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                status:
                  type: string
                  enum: [ACTIVE, INVESTIGATING, RESOLVED, FALSE_POSITIVE]
                notes:
                  type: string
      responses:
        '200':
          description: Incident updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SecurityIncident'

  /api/stats:
    get:
      tags:
        - Statistics
      summary: Get system statistics
      description: Retrieve comprehensive security monitoring statistics
      operationId: getStatistics
      responses:
        '200':
          description: System statistics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatisticsResponse'

  /api/alerts:
    get:
      tags:
        - Alerts
      summary: Get recent alerts
      description: Retrieve recent security alerts
      operationId: getAlerts
      parameters:
        - $ref: '#/components/parameters/LimitParam'
      responses:
        '200':
          description: List of alerts
          content:
            application/json:
              schema:
                type: object
                properties:
                  alerts:
                    type: array
                    items:
                      $ref: '#/components/schemas/SecurityAlert'

  /api/webhooks/health:
    get:
      tags:
        - Webhooks
      summary: Get webhook health status
      description: Retrieve health status of all configured webhooks
      operationId: getWebhookHealth
      responses:
        '200':
          description: Webhook health status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebhookHealthResponse'

  /api/webhooks/failed:
    get:
      tags:
        - Webhooks
      summary: Get failed webhooks
      description: Retrieve webhooks that failed delivery
      operationId: getFailedWebhooks
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
      responses:
        '200':
          description: Failed webhooks
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/FailedWebhook'

  /api/webhooks/{id}/test:
    post:
      tags:
        - Webhooks
      summary: Test webhook
      description: Send a test notification to a webhook
      operationId: testWebhook
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Test sent successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string

  /api/cache/stats:
    get:
      tags:
        - Cache
      summary: Get cache statistics
      description: Retrieve Redis cache statistics
      operationId: getCacheStats
      responses:
        '200':
          description: Cache statistics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CacheStatsResponse'

  /api/cache/blacklist:
    get:
      tags:
        - Cache
      summary: Get blacklisted IPs
      description: Retrieve all blacklisted IP addresses
      operationId: getBlacklist
      responses:
        '200':
          description: Blacklisted IPs
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/BlacklistEntry'

    post:
      tags:
        - Cache
      summary: Add IP to blacklist
      description: Blacklist an IP address
      operationId: addToBlacklist
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - ip
              properties:
                ip:
                  type: string
                reason:
                  type: string
                durationSeconds:
                  type: integer
                  default: 3600
      responses:
        '201':
          description: IP blacklisted

  /api/cache/blacklist/{ip}:
    delete:
      tags:
        - Cache
      summary: Remove IP from blacklist
      operationId: removeFromBlacklist
      parameters:
        - name: ip
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: IP removed from blacklist

  /api/circuit-breakers/status:
    get:
      tags:
        - Circuit Breakers
      summary: Get circuit breaker status
      description: Retrieve status of all circuit breakers
      operationId: getCircuitBreakerStatus
      responses:
        '200':
          description: Circuit breaker status
          content:
            application/json:
              schema:
                type: object
                additionalProperties:
                  $ref: '#/components/schemas/CircuitBreakerStatus'

  /api/circuit-breakers/{name}/open:
    post:
      tags:
        - Circuit Breakers
      summary: Open circuit breaker
      description: Manually open a circuit breaker
      operationId: openCircuitBreaker
      parameters:
        - name: name
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Circuit breaker opened

  /api/circuit-breakers/{name}/close:
    post:
      tags:
        - Circuit Breakers
      summary: Close circuit breaker
      description: Manually close a circuit breaker
      operationId: closeCircuitBreaker
      parameters:
        - name: name
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Circuit breaker closed

components:
  parameters:
    LimitParam:
      name: limit
      in: query
      description: Maximum number of results to return
      schema:
        type: integer
        default: 100
        maximum: 1000

    OffsetParam:
      name: offset
      in: query
      description: Number of results to skip
      schema:
        type: integer
        default: 0

    EventIdParam:
      name: eventId
      in: path
      required: true
      description: Event ID
      schema:
        type: string

    IncidentIdParam:
      name: incidentId
      in: path
      required: true
      description: Incident ID
      schema:
        type: string

  schemas:
    HealthResponse:
      type: object
      properties:
        status:
          type: string
          enum: [healthy, degraded, unhealthy]
        uptime:
          type: integer
          description: Uptime in seconds
        components:
          type: object
          properties:
            database:
              $ref: '#/components/schemas/ComponentHealth'
            redis:
              $ref: '#/components/schemas/ComponentHealth'
            prometheus:
              $ref: '#/components/schemas/ComponentHealth'
        timestamp:
          type: integer
          format: int64

    ComponentHealth:
      type: object
      properties:
        healthy:
          type: boolean
        message:
          type: string
        lastCheck:
          type: integer
          format: int64

    SecurityEvent:
      type: object
      properties:
        id:
          type: string
        type:
          type: string
          enum: [SQL_INJECTION, XSS, COMMAND_INJECTION, PATH_TRAVERSAL, DDOS, RATE_LIMIT_EXCEEDED, LDAP_INJECTION, XXE, SSRF, PROTOTYPE_POLLUTION]
        severity:
          type: string
          enum: [LOW, MEDIUM, HIGH, CRITICAL]
        ip:
          type: string
        userAgent:
          type: string
        url:
          type: string
        method:
          type: string
        timestamp:
          type: integer
          format: int64
        riskScore:
          type: integer
          minimum: 0
          maximum: 100
        threatLevel:
          type: string
          enum: [LOW, MEDIUM, HIGH, CRITICAL]
        details:
          type: object
        blocked:
          type: boolean

    SecurityIncident:
      type: object
      properties:
        id:
          type: string
        severity:
          type: string
          enum: [LOW, MEDIUM, HIGH, CRITICAL]
        status:
          type: string
          enum: [ACTIVE, INVESTIGATING, RESOLVED, FALSE_POSITIVE]
        title:
          type: string
        description:
          type: string
        events:
          type: array
          items:
            type: string
        createdAt:
          type: integer
          format: int64
        updatedAt:
          type: integer
          format: int64
        resolvedAt:
          type: integer
          format: int64
        notes:
          type: array
          items:
            type: object
            properties:
              timestamp:
                type: integer
                format: int64
              author:
                type: string
              text:
                type: string

    SecurityAlert:
      type: object
      properties:
        id:
          type: string
        type:
          type: string
        severity:
          type: string
          enum: [LOW, MEDIUM, HIGH, CRITICAL]
        message:
          type: string
        timestamp:
          type: integer
          format: int64
        metadata:
          type: object

    StatisticsResponse:
      type: object
      properties:
        uptime:
          type: integer
        eventsProcessed:
          type: integer
        threatsDetected:
          type: integer
        incidentsActive:
          type: integer
        requestsPerSecond:
          type: number
        avgResponseTime:
          type: number
        memoryUsage:
          type: object
          properties:
            used:
              type: integer
            total:
              type: integer
            percentage:
              type: number
        threatsByType:
          type: object
          additionalProperties:
            type: integer
        eventsBySeverity:
          type: object
          additionalProperties:
            type: integer

    WebhookHealthResponse:
      type: object
      additionalProperties:
        type: object
        properties:
          healthy:
            type: boolean
          successRate:
            type: number
          lastSuccess:
            type: integer
            format: int64
          lastFailure:
            type: integer
            format: int64
          totalSent:
            type: integer
          totalFailed:
            type: integer

    FailedWebhook:
      type: object
      properties:
        webhookId:
          type: string
        alert:
          $ref: '#/components/schemas/SecurityAlert'
        error:
          type: string
        timestamp:
          type: integer
          format: int64
        retryCount:
          type: integer

    CacheStatsResponse:
      type: object
      properties:
        connected:
          type: boolean
        totalKeys:
          type: integer
        keysByType:
          type: object
          additionalProperties:
            type: integer

    BlacklistEntry:
      type: object
      properties:
        ip:
          type: string
        reason:
          type: string
        blacklistedAt:
          type: integer
          format: int64
        expiresAt:
          type: integer
          format: int64

    CircuitBreakerStatus:
      type: object
      properties:
        state:
          type: string
          enum: [CLOSED, OPEN, HALF_OPEN]
        failures:
          type: integer
        successes:
          type: integer
        totalRequests:
          type: integer
        failureRate:
          type: number
        lastStateChange:
          type: integer
          format: int64

    CreateEventRequest:
      type: object
      required:
        - type
        - ip
      properties:
        type:
          type: string
        ip:
          type: string
        userAgent:
          type: string
        url:
          type: string
        method:
          type: string
        details:
          type: object

    ErrorResponse:
      type: object
      properties:
        error:
          type: string
        code:
          type: string
        message:
          type: string
        timestamp:
          type: integer
          format: int64

  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key

    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

security:
  - ApiKeyAuth: []
  - BearerAuth: []
